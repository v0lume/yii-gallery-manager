(function(e){var a={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};function t(t,s){var o=e.extend({},a,s);var n=o.csrfToken?"&"+o.csrfTokenName+"="+o.csrfToken:"";var r={};var i=e(t);if(!o.hasName){if(!o.hasDesc)i.addClass("no-name-no-desc");else i.addClass("no-name")}else if(!o.hasDesc)i.addClass("no-desc");o.wId=i.attr("id");var c=e(".sorter",i);var l=e(".images",c);var d=e(".editor-modal",i);var p=e(".progress-overlay",i);var f=e(".upload-progress",p);var h=e(".form",d);function v(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function u(a,t,s,n){var r='<div class="photo-editor">'+'<div class="preview"><img src="'+v(t)+'" alt=""/></div>'+"<div>"+(o.hasName?'<label for="photo_name_'+a+'">'+o.nameLabel+":</label>"+'<input type="text" name="photo['+a+'][name]" class="input-xlarge" value="'+v(s)+'" id="photo_name_'+a+'"/>':"")+(o.hasDesc?'<label for="photo_description_'+a+'">'+o.descriptionLabel+":</label>"+'<textarea name="photo['+a+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+a+'">'+v(n)+"</textarea>":"")+"</div>"+"</div>";return e(r)}var m='<div class="photo">'+'<div class="image-preview"><img src=""/></div><div class="caption">';if(o.hasName)m+="<h5></h5>";if(o.hasDesc)m+="<p></p>";m+='</div><div class="actions">';if(o.hasName)m+='<span class="editPhoto btn btn-primary"><i class="icon-edit icon-white"></i></span> ';m+='<span class="deletePhoto btn btn-danger"><i class="icon-remove icon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';function g(a,t,s,n,i){var c=e(m);r[a]=c;c.data("id",a);c.data("rank",i);e("img",c).attr("src",t);if(o.hasName)e(".caption h5",c).text(s);if(o.hasDesc)e(".caption p",c).text(n);l.append(c);return c}function k(a){var t=a.length;var s=h.empty();for(var o=0;o<t;o++){var n=a[o];var i=r[n],c=e("img",i).attr("src"),l=e(".caption h5",i).text(),p=e(".caption p",i).text();s.append(u(n,c,l,p))}if(t>0)d.modal("show")}function D(a){e.ajax({type:"POST",url:o.deleteUrl,data:"id[]="+a.join("&id[]=")+n,success:function(e){if(e=="OK"){for(var t=0,s=a.length;t<s;t++){r[a[t]].remove();delete r[a[t]]}}else alert(e)}})}function w(a){a.preventDefault();var t=e(this).closest(".photo");var s=t.data("id");D([s]);return false}function b(a){a.preventDefault();var t=e(this).closest(".photo");var s=t.data("id");k([s]);return false}function T(){var a=e(".photo.selected",c).length;e(".select_all",i).prop("checked",e(".photo",c).length==a);if(a==0){e(".edit_selected, .remove_selected",i).addClass("disabled")}else{e(".edit_selected, .remove_selected",i).removeClass("disabled")}}function x(){var a=e(this);if(a.is(":checked"))a.closest(".photo").addClass("selected");else a.closest(".photo").removeClass("selected");T()}l.on("click",".photo .deletePhoto",w).on("click",".photo .editPhoto",b).on("click",".photo .photo-select",x);e(".images",c).sortable().disableSelection().bind("sortstop",function(){var a=[];e(".photo",c).each(function(){var t=e(this);a.push("order["+t.data("id")+"]="+t.data("rank"))});e.ajax({type:"POST",url:o.arrangeUrl,data:a.join("&")+n,dataType:"json"}).done(function(e){for(var a in e[a]){r[a].data("rank",e[a])}})});if(window.FormData!==undefined){var _=e(".afile",i).attr("name");function N(e){p.show();f.css("width","5%");var a=e.length;var t=0;var s=[];for(var n=0;n<a;n++){var r=new FormData;r.append(_,e[n]);if(o.csrfToken){r.append(o.csrfTokenName,o.csrfToken)}var i=new XMLHttpRequest;i.open("POST",o.uploadUrl,true);i.onload=function(){t++;if(this.status==200){var e=JSON.parse(this.response);g(e["id"],e["preview"],e["name"],e["description"],e["rank"]);s.push(e["id"])}else{}f.css("width",""+(5+95*t/a)+"%");console.log(t);if(t===a){f.css("width","100%");p.hide();if(o.hasName||o.hasDesc)k(s)}};i.send(r)}}(function(){var e=i[0];var a=false;var t=false;setInterval(function(){if(a!=t){if(a)e.classList.add("over");else e.classList.remove("over");t=a}},30);function s(e){e.preventDefault();a=true;return false}function o(){a=false;return false}function n(e){e.preventDefault();e.stopPropagation();var t=e.dataTransfer.files;N(t);a=false;return false}function r(){a=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",o,false);e.addEventListener("drop",n,false);e.addEventListener("dragend",r,false)})();e(".afile",i).attr("multiple","true").on("change",function(e){e.preventDefault();N(this.files)})}else{e(".afile",i).on("change",function(a){a.preventDefault();var t=[];p.show();f.css("width","5%");var s={};if(o.csrfToken)s[o.csrfTokenName]=o.csrfToken;e.ajax({type:"POST",url:o.uploadUrl,data:s,files:e(this),iframe:true,processData:false,dataType:"json"}).done(function(e){g(e["id"],e["preview"],e["name"],e["description"],e["rank"]);t.push(e["id"]);f.css("width","100%");p.hide();if(o.hasName||o.hasDesc)k(t)})})}e(".save-changes",d).click(function(a){a.preventDefault();e.post(o.updateUrl,e("input, textarea",h).serialize()+n,function(a){var t=a.length;for(var s=0;s<t;s++){var n=a[s];var l=r[n.id];e("img",l).attr("src",n["src"]);if(o.hasName)e(".caption h5",l).text(n["name"]);if(o.hasDesc)e(".caption p",l).text(n["description"])}d.modal("hide");e(".photo.selected",c).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected");e(".select_all",i).prop("checked",false);T()},"json")});e(".edit_selected",i).click(function(a){a.preventDefault();var t=[];e(".photo.selected",c).each(function(){t.push(e(this).data("id"))});k(t);return false});e(".remove_selected",i).click(function(a){a.preventDefault();var t=[];e(".photo.selected",c).each(function(){t.push(e(this).data("id"))});D(t)});e(".select_all",i).change(function(){if(e(this).prop("checked")){e(".photo",c).each(function(){e(".photo-select",this).prop("checked",true)}).addClass("selected")}else{e(".photo.selected",c).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected")}T()});for(var y=0,L=o.photos.length;y<L;y++){var C=o.photos[y];g(C["id"],C["preview"],C["name"],C["description"],C["rank"]).data("data",C)}}e.fn.galleryManager=function(e){if(this.length){this.each(function(){t(this,e)})}}})(jQuery);