(function(e){function a(a,t){this.defaults={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};var s=e.extend({},this.defaults,t);var n=s.csrfToken?"&"+s.csrfTokenName+"="+s.csrfToken:"";var r=e(a);s.wId=r.attr("id");var i=e(".sorter",r);var o=e(".images",i);var l=e(".editor-modal",r);var c=e(".form",l);function d(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function p(a,t,n,r){var i='<div class="photo-editor">'+'<div class="preview"><img src="'+d(t)+'" alt=""/></div>'+"<div>"+(s.hasName?'<label for="photo_name_'+a+'">'+s.nameLabel+":</label>"+'<input type="text" name="photo['+a+'][name]" class="input-xlarge" value="'+d(n)+'" id="photo_name_'+a+'"/>':"")+(s.hasDesc?'<label for="photo_description_'+a+'">'+s.descriptionLabel+":</label>"+'<textarea name="photo['+a+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+a+'">'+d(r)+"</textarea>":"")+"</div>"+"</div>";return e(i)}function f(a,t,n,r,i){var o='<div id="'+s.wId+"-"+a+'" class="photo">'+'<div class="image-preview"><img src="'+d(t)+'"/></div><div class="caption">';if(s.hasName)o+="<h5>"+d(n)+"</h5>";if(s.hasDesc)o+="<p>"+d(r)+"</p>";o+='</div><input type="hidden" name="order['+a+']" value="'+i+'"/><div class="actions">'+(s.hasName||s.hasDesc?'<span data-photo-id="'+a+'" class="editPhoto btn btn-primary"><i class="icon-edit icon-white"></i></span> ':"")+'<span data-photo-id="'+a+'" class="deletePhoto btn btn-danger"><i class="icon-remove icon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';return e(o)}function h(a){a.preventDefault();var t=e(this).data("photo-id");e.ajax({type:"POST",url:s.deleteUrl,data:"id="+t+n,success:function(a){if(a=="OK")e("#"+s.wId+"-"+t).remove();else alert(a)}});return false}function v(a){a.preventDefault();var t=e(this).data("photo-id");var s=e(this).parents(".photo");var n=e("img",s[0]).attr("src");var r=e(".caption h5",s[0]).text();var i=e(".caption p",s[0]).text();c.empty();c.append(p(t,n,r,i));l.modal("show");return false}function u(){var a=e(".photo.selected",i).length;e(".select_all",r).prop("checked",e(".photo",i).length==a);if(a==0){e(".edit_selected, .remove_selected",r).addClass("disabled")}else{e(".edit_selected, .remove_selected",r).removeClass("disabled")}}function m(){var a=e(this);if(a.is(":checked"))a.parent().addClass("selected");else a.parent().removeClass("selected");u()}o.on("click",".photo .deletePhoto",h).on("click",".photo .editPhoto",v).on("click",".photo .photo-select",m);e(".images",i).sortable().disableSelection().bind("sortstop",function(){e.post(s.arrangeUrl,e("input",i).serialize()+"&ajax=true"+n,function(){},"json")});if(window.FormData!==undefined){var g=e(".afile",r).attr("name");function k(e){var a=e.length;var t=0;c.empty();for(var n=0;n<a;n++){var r=new FormData;r.append(g,e[n]);if(s.csrfToken){r.append(s.csrfTokenName,s.csrfToken)}var i=new XMLHttpRequest;i.open("POST",s.uploadUrl,true);i.onload=function(){t++;if(this.status==200){var e=JSON.parse(this.response);var n=f(e["id"],e["preview"],e["name"],e["description"],e["rank"]);o.append(n);if(s.hasName||s.hasDesc)c.append(p(e["id"],e["preview"],e["name"],e["description"]))}if(t===a&&(s.hasName||s.hasDesc))l.modal("show")};i.send(r)}}(function(){var e=r[0];var a=false;var t=false;setInterval(function(){if(a!=t){if(a)e.classList.add("over");else e.classList.remove("over");t=a}},30);function s(e){e.preventDefault();a=true;return false}function n(){a=false;return false}function i(e){e.preventDefault();e.stopPropagation();var t=e.dataTransfer.files;k(t);a=false;return false}function o(){a=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",n,false);e.addEventListener("drop",i,false);e.addEventListener("dragend",o,false)})();e(".afile",r).attr("multiple","true").on("change",function(e){e.preventDefault();k(this.files)})}else{e(".afile",r).on("change",function(a){a.preventDefault();c.empty();var t={};if(s.csrfToken)t[s.csrfTokenName]=s.csrfToken;e.ajax({type:"POST",url:s.uploadUrl,data:t,files:e(this),iframe:true,processData:false,dataType:"json"}).done(function(e){var a=f(e["id"],e["preview"],e["name"],e["description"],e["rank"]);o.append(a);if(s.hasName||s.hasDesc)c.append(p(e["id"],e["preview"],e["name"],e["description"]));if(s.hasName||s.hasDesc)l.modal("show")})})}e(".save-changes",l).click(function(a){a.preventDefault();e.post(s.updateUrl,e("input, textarea",c).serialize()+"&ajax=true"+n,function(a){var t=a.length;for(var n=0;n<t;n++){var o=a[n];var c=e("#"+s.wId+"-"+o.id);e("img",c).attr("src",o["src"]);if(s.hasName)e(".caption h5",c).text(o["name"]);if(s.hasDesc)e(".caption p",c).text(o["description"])}l.modal("hide");e(".photo.selected",i).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected");e(".select_all",r).prop("checked",false);u()},"json")});e(".edit_selected",r).click(function(a){a.preventDefault();var t=0;var n=c.empty();e(".photo.selected",i).each(function(){t++;var a=e(this),r=a.attr("id").substr((s.wId+"-").length),i=e("img",a[0]).attr("src"),o=e(".caption h5",a[0]).text(),l=e(".caption p",a[0]).text();n.append(p(r,i,o,l))});if(t>0)l.modal("show");return false});e(".remove_selected",r).click(function(a){a.preventDefault();e(".photo.selected",i).each(function(){var a=e(this).attr("id").substr((s.wId+"-").length);e.ajax({type:"POST",url:s.deleteUrl,data:"id="+a+n,success:function(t){if(t=="OK")e("#"+s.wId+"-"+a).remove();else alert(t)}})})});e(".select_all",r).change(function(){if(e(this).prop("checked")){e(".photo",i).each(function(){e(".photo-select",this).prop("checked",true)}).addClass("selected")}else{e(".photo.selected",i).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected")}u()});for(var w in s.photos){var D=s.photos[w];var b=f(D["id"],D["preview"],D["name"],D["description"],D["rank"]).data("data",D);o.append(b)}}e.fn.galleryManager=function(e){if(this.length){this.each(function(){a(this,e)})}}})(jQuery);