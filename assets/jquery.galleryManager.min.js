(function(a){function b(b,c){function j(a){return(a+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function k(a,b,c,e){return'<div class="photo-editor"><div class="preview"><img src="'+j(b)+'" alt=""/></div>'+"<div>"+(d.hasName?'<label for="photo_name_'+a+'">'+d.nameLabel+":</label>"+'<input type="text" name="photo['+a+'][name]" class="input-xlarge" value="'+j(c)+'" id="photo_name_'+a+'"/>':"")+(d.hasDesc?'<label for="photo_description_'+a+'">'+d.descriptionLabel+":</label>"+'<textarea name="photo['+a+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+a+'">'+j(e)+"</textarea>":"")+"</div>"+"</div>"}function l(a,b,c,e,f){var g='<div id="'+d.wId+"-"+a+'" class="photo">'+'<div class="image-preview"><img src="'+j(b)+'"/></div><div class="caption">';return d.hasName&&(g+="<h5>"+j(c)+"</h5>"),d.hasDesc&&(g+="<p>"+j(e)+"</p>"),g+='</div><input type="hidden" name="order['+a+']" value="'+f+'"/><div class="actions">'+(d.hasName||d.hasDesc?'<span data-photo-id="'+a+'" class="editPhoto btn btn-primary"><i class="icon-edit icon-white"></i></span> ':"")+'<span data-photo-id="'+a+'" class="deletePhoto btn btn-danger"><i class="icon-remove icon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>',g}function m(b){b.preventDefault();var c=a(this).data("photo-id");return a.ajax({type:"POST",url:d.deleteUrl,data:"id="+c+(d.csrfToken?"&"+d.csrfTokenName+"="+d.csrfToken:""),success:function(b){b=="OK"?a("#"+d.wId+"-"+c).remove():alert(b)}}),!1}function n(b){b.preventDefault();var c=a(this).data("photo-id"),d=a(this).parents(".photo"),e=a("img",d[0]).attr("src"),f=a(".caption h5",d[0]).text(),g=a(".caption p",d[0]).text();return i.html(k(c,e,f,g)),h.modal("show"),!1}function o(){var b=a(".photo.selected",f).length;a(".select_all",e).prop("checked",a(".photo",f).length==b),b==0?a(".edit_selected, .remove_selected",e).addClass("disabled"):a(".edit_selected, .remove_selected",e).removeClass("disabled")}function p(){var b=a(this);b.is(":checked")?b.parent().addClass("selected"):b.parent().removeClass("selected"),o()}function q(b){a(".deletePhoto",b).click(m),a(".editPhoto",b).click(n),a(".photo-select",b).change(p)}this.defaults={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:!0,hasDesc:!0,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};var d=a.extend({},this.defaults,c),e=a(b);d.wId=e.attr("id");var f=a(".sorter",e),g=a(".images",f),h=a(".editor-modal",e),i=a(".form",h);a(".photo",e).each(function(){q(this)}),a(".images",f).sortable().disableSelection().bind("sortstop",function(){a.post(d.arrangeUrl,a("input",f).serialize()+"&ajax=true"+(d.csrfToken?"&"+d.csrfTokenName+"="+d.csrfToken:""),function(){},"json")}),typeof window.FormData=="function"?a(".afile",e).attr("multiple","true").on("change",function(b){b.preventDefault();var c=this.files.length,e=0;i.html("");for(var f=0;f<c;f++){var j=new FormData;j.append(this.name,this.files[f]),d.csrfToken&&j.append(d.csrfTokenName,d.csrfToken);var m=new XMLHttpRequest;m.open("POST",d.uploadUrl,!0),m.onload=function(){e++;if(this.status==200){var b=JSON.parse(this.response),f=a(l(b.id,b.preview,b.name,b.description,b.rank));q(f),g.append(f),(d.hasName||d.hasDesc)&&i.append(a(k(b.id,b.preview,b.name,b.description)))}e===c&&(d.hasName||d.hasDesc)&&h.modal("show")},m.send(j)}}):a(".afile",e).on("change",function(b){b.preventDefault(),i.html(""),a.ajax(d.uploadUrl,{data:d.csrfToken?d.csrfTokenName+"="+d.csrfToken:"",files:a(this),iframe:!0,dataType:"json"}).done(function(b){var c=a(l(b.id,b.preview,b.name,b.description,b.rank));q(c),g.append(c),(d.hasName||d.hasDesc)&&i.append(a(k(b.id,b.preview,b.name,b.description))),(d.hasName||d.hasDesc)&&h.modal("show")})}),a(".save-changes",h).click(function(b){b.preventDefault(),a.post(d.updateUrl,a("input, textarea",i).serialize()+"&ajax=true"+(d.csrfToken?"&"+d.csrfTokenName+"="+d.csrfToken:""),function(b){var c=b.length;for(var g=0;g<c;g++){var i=b[g],j=a("#"+d.wId+"-"+i.id);a("img",j).attr("src",i.src),d.hasName&&a(".caption h5",j).text(i.name),d.hasDesc&&a(".caption p",j).text(i.description)}h.modal("hide"),a(".photo.selected",f).each(function(){a(".photo-select",this).prop("checked",!1)}).removeClass("selected"),a(".select_all",e).prop("checked",!1),o()},"json")}),a(".edit_selected",e).click(function(b){b.preventDefault();var c=0,e=i.html("");return a(".photo.selected",f).each(function(){c++;var b=a(this),f=b.attr("id").substr((d.wId+"-").length),g=a("img",b[0]).attr("src"),h=a(".caption h5",b[0]).text(),i=a(".caption p",b[0]).text();e.append(k(f,g,h,i))}),c>0&&h.modal("show"),!1}),a(".remove_selected",e).click(function(b){b.preventDefault(),a(".photo.selected",f).each(function(){var b=a(this).attr("id").substr((d.wId+"-").length);a.ajax({type:"POST",url:d.deleteUrl,data:"id="+b+(d.csrfToken?"&"+d.csrfTokenName+"="+d.csrfToken:""),success:function(c){c=="OK"?a("#"+d.wId+"-"+b).remove():alert(c)}})})}),a(".select_all",e).change(function(){a(this).prop("checked")?a(".photo",f).each(function(){a(".photo-select",this).prop("checked",!0)}).addClass("selected"):a(".photo.selected",f).each(function(){a(".photo-select",this).prop("checked",!1)}).removeClass("selected"),o()});for(var r in d.photos){var s=d.photos[r],t=a(l(s.id,s.preview,s.name,s.description,s.rank)).data("data",s);q(t),g.append(t)}}a.fn.galleryManager=function(a){this.length&&this.each(function(){b(this,a)})}})(jQuery);