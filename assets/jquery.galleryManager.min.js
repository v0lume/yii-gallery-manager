(function(e){function a(a,t){this.defaults={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};var s=e.extend({},this.defaults,t);var o=s.csrfToken?"&"+s.csrfTokenName+"="+s.csrfToken:"";var r=e(a);s.wId=r.attr("id");var i=e(".sorter",r);var n=e(".images",i);var l=e(".editor-modal",r);var c=e(".progress-modal",r);var d=e(".upload-progress",c);var p=e(".form",l);function h(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function f(a,t,o,r){var i='<div class="photo-editor">'+'<div class="preview"><img src="'+h(t)+'" alt=""/></div>'+"<div>"+(s.hasName?'<label for="photo_name_'+a+'">'+s.nameLabel+":</label>"+'<input type="text" name="photo['+a+'][name]" class="input-xlarge" value="'+h(o)+'" id="photo_name_'+a+'"/>':"")+(s.hasDesc?'<label for="photo_description_'+a+'">'+s.descriptionLabel+":</label>"+'<textarea name="photo['+a+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+a+'">'+h(r)+"</textarea>":"")+"</div>"+"</div>";return e(i)}function v(a,t,o,r,i){var n='<div id="'+s.wId+"-"+a+'" class="photo">'+'<div class="image-preview"><img src="'+h(t)+'"/></div><div class="caption">';if(s.hasName)n+="<h5>"+h(o)+"</h5>";if(s.hasDesc)n+="<p>"+h(r)+"</p>";n+='</div><input type="hidden" name="order['+a+']" value="'+i+'"/><div class="actions">'+(s.hasName||s.hasDesc?'<span data-photo-id="'+a+'" class="editPhoto btn btn-primary"><i class="icon-edit icon-white"></i></span> ':"")+'<span data-photo-id="'+a+'" class="deletePhoto btn btn-danger"><i class="icon-remove icon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';return e(n)}function u(a){a.preventDefault();var t=e(this).data("photo-id");e.ajax({type:"POST",url:s.deleteUrl,data:"id="+t+o,success:function(a){if(a=="OK")e("#"+s.wId+"-"+t).remove();else alert(a)}});return false}function m(a){a.preventDefault();var t=e(this).data("photo-id");var s=e(this).parents(".photo");var o=e("img",s[0]).attr("src");var r=e(".caption h5",s[0]).text();var i=e(".caption p",s[0]).text();p.empty();p.append(f(t,o,r,i));l.modal("show");return false}function g(){var a=e(".photo.selected",i).length;e(".select_all",r).prop("checked",e(".photo",i).length==a);if(a==0){e(".edit_selected, .remove_selected",r).addClass("disabled")}else{e(".edit_selected, .remove_selected",r).removeClass("disabled")}}function w(){var a=e(this);if(a.is(":checked"))a.parent().addClass("selected");else a.parent().removeClass("selected");g()}n.on("click",".photo .deletePhoto",u).on("click",".photo .editPhoto",m).on("click",".photo .photo-select",w);e(".images",i).sortable().disableSelection().bind("sortstop",function(){e.post(s.arrangeUrl,e("input",i).serialize()+"&ajax=true"+o,function(){},"json")});if(window.FormData!==undefined){var k=e(".afile",r).attr("name");function D(e){c.modal("show");d.css("width","5%");var a=e.length;var t=0;p.empty();for(var o=0;o<a;o++){var r=new FormData;r.append(k,e[o]);if(s.csrfToken){r.append(s.csrfTokenName,s.csrfToken)}var i=new XMLHttpRequest;i.open("POST",s.uploadUrl,true);i.onload=function(){t++;if(this.status==200){var e=JSON.parse(this.response);var o=v(e["id"],e["preview"],e["name"],e["description"],e["rank"]);n.append(o);if(s.hasName||s.hasDesc)p.append(f(e["id"],e["preview"],e["name"],e["description"]))}d.css("width",""+(5+95*t/a)+"%");console.log(t);if(t===a&&(s.hasName||s.hasDesc)){d.css("width","100%");c.modal("hide");l.modal("show")}};i.send(r)}}(function(){var e=r[0];var a=false;var t=false;setInterval(function(){if(a!=t){if(a)e.classList.add("over");else e.classList.remove("over");t=a}},30);function s(e){e.preventDefault();a=true;return false}function o(){a=false;return false}function i(e){e.preventDefault();e.stopPropagation();var t=e.dataTransfer.files;D(t);a=false;return false}function n(){a=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",o,false);e.addEventListener("drop",i,false);e.addEventListener("dragend",n,false)})();e(".afile",r).attr("multiple","true").on("change",function(e){e.preventDefault();D(this.files)})}else{e(".afile",r).on("change",function(a){a.preventDefault();p.empty();c.modal("show");d.css("width","5%");var t={};if(s.csrfToken)t[s.csrfTokenName]=s.csrfToken;e.ajax({type:"POST",url:s.uploadUrl,data:t,files:e(this),iframe:true,processData:false,dataType:"json"}).done(function(e){var a=v(e["id"],e["preview"],e["name"],e["description"],e["rank"]);n.append(a);if(s.hasName||s.hasDesc)p.append(f(e["id"],e["preview"],e["name"],e["description"]));d.css("width","100%");c.modal("hide");if(s.hasName||s.hasDesc)l.modal("show")})})}e(".save-changes",l).click(function(a){a.preventDefault();e.post(s.updateUrl,e("input, textarea",p).serialize()+"&ajax=true"+o,function(a){var t=a.length;for(var o=0;o<t;o++){var n=a[o];var c=e("#"+s.wId+"-"+n.id);e("img",c).attr("src",n["src"]);if(s.hasName)e(".caption h5",c).text(n["name"]);if(s.hasDesc)e(".caption p",c).text(n["description"])}l.modal("hide");e(".photo.selected",i).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected");e(".select_all",r).prop("checked",false);g()},"json")});e(".edit_selected",r).click(function(a){a.preventDefault();var t=0;var o=p.empty();e(".photo.selected",i).each(function(){t++;var a=e(this),r=a.attr("id").substr((s.wId+"-").length),i=e("img",a[0]).attr("src"),n=e(".caption h5",a[0]).text(),l=e(".caption p",a[0]).text();o.append(f(r,i,n,l))});if(t>0)l.modal("show");return false});e(".remove_selected",r).click(function(a){a.preventDefault();e(".photo.selected",i).each(function(){var a=e(this).attr("id").substr((s.wId+"-").length);e.ajax({type:"POST",url:s.deleteUrl,data:"id="+a+o,success:function(t){if(t=="OK")e("#"+s.wId+"-"+a).remove();else alert(t)}})})});e(".select_all",r).change(function(){if(e(this).prop("checked")){e(".photo",i).each(function(){e(".photo-select",this).prop("checked",true)}).addClass("selected")}else{e(".photo.selected",i).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected")}g()});for(var b in s.photos){var x=s.photos[b];var T=v(x["id"],x["preview"],x["name"],x["description"],x["rank"]).data("data",x);n.append(T)}}e.fn.galleryManager=function(e){if(this.length){this.each(function(){a(this,e)})}}})(jQuery);