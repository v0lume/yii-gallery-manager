(function(e){function t(t,a){this.defaults={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};var s=e.extend({},this.defaults,a);var r=s.csrfToken?"&"+s.csrfTokenName+"="+s.csrfToken:"";var i=e(t);s.wId=i.attr("id");var n=e(".sorter",i);var o=e(".images",n);var l=e(".editor-modal",i);var c=e(".progress-overlay",i);var d=e(".upload-progress",c);var p=e(".form",l);function h(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function f(t,a,r,i){var n='<div class="photo-editor">'+'<div class="preview"><img src="'+h(a)+'" alt=""/></div>'+"<div>"+(s.hasName?'<label for="photo_name_'+t+'">'+s.nameLabel+":</label>"+'<input type="text" name="photo['+t+'][name]" class="input-xlarge" value="'+h(r)+'" id="photo_name_'+t+'"/>':"")+(s.hasDesc?'<label for="photo_description_'+t+'">'+s.descriptionLabel+":</label>"+'<textarea name="photo['+t+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+t+'">'+h(i)+"</textarea>":"")+"</div>"+"</div>";return e(n)}function v(t,a,r,i,n){var o='<div id="'+s.wId+"-"+t+'" class="photo">'+'<div class="image-preview"><img src="'+h(a)+'"/></div><div class="caption">';if(s.hasName)o+="<h5>"+h(r)+"</h5>";if(s.hasDesc)o+="<p>"+h(i)+"</p>";o+='</div><input type="hidden" name="order['+t+']" value="'+n+'"/><div class="actions">'+(s.hasName||s.hasDesc?'<span data-photo-id="'+t+'" class="editPhoto btn btn-primary"><i class="icon-edit icon-white"></i></span> ':"")+'<span data-photo-id="'+t+'" class="deletePhoto btn btn-danger"><i class="icon-remove icon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';return e(o)}function u(t){t.preventDefault();var a=e(this).data("photo-id");e.ajax({type:"POST",url:s.deleteUrl,data:"id="+a+r,success:function(t){if(t=="OK")e("#"+s.wId+"-"+a).remove();else alert(t)}});return false}function m(t){t.preventDefault();var a=e(this).data("photo-id");var s=e(this).parents(".photo");var r=e("img",s[0]).attr("src");var i=e(".caption h5",s[0]).text();var n=e(".caption p",s[0]).text();p.empty();p.append(f(a,r,i,n));l.modal("show");return false}function g(){var t=e(".photo.selected",n).length;e(".select_all",i).prop("checked",e(".photo",n).length==t);if(t==0){e(".edit_selected, .remove_selected",i).addClass("disabled")}else{e(".edit_selected, .remove_selected",i).removeClass("disabled")}}function w(){var t=e(this);if(t.is(":checked"))t.parent().addClass("selected");else t.parent().removeClass("selected");g()}o.on("click",".photo .deletePhoto",u).on("click",".photo .editPhoto",m).on("click",".photo .photo-select",w);e(".images",n).sortable().disableSelection().bind("sortstop",function(){e.post(s.arrangeUrl,e("input",n).serialize()+"&ajax=true"+r,function(){},"json")});if(window.FormData!==undefined){var k=e(".afile",i).attr("name");function D(e){c.show();d.css("width","5%");var t=e.length;var a=0;p.empty();for(var r=0;r<t;r++){var i=new FormData;i.append(k,e[r]);if(s.csrfToken){i.append(s.csrfTokenName,s.csrfToken)}var n=new XMLHttpRequest;n.open("POST",s.uploadUrl,true);n.onload=function(){a++;if(this.status==200){var e=JSON.parse(this.response);var r=v(e["id"],e["preview"],e["name"],e["description"],e["rank"]);o.append(r);if(s.hasName||s.hasDesc)p.append(f(e["id"],e["preview"],e["name"],e["description"]))}d.css("width",""+(5+95*a/t)+"%");console.log(a);if(a===t&&(s.hasName||s.hasDesc)){d.css("width","100%");c.hide();l.modal("show")}};n.send(i)}}(function(){var e=i[0];var t=false;var a=false;setInterval(function(){if(t!=a){if(t)e.classList.add("over");else e.classList.remove("over");a=t}},30);function s(e){e.preventDefault();t=true;return false}function r(){t=false;return false}function n(e){e.preventDefault();e.stopPropagation();var a=e.dataTransfer.files;D(a);t=false;return false}function o(){t=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",r,false);e.addEventListener("drop",n,false);e.addEventListener("dragend",o,false)})();e(".afile",i).attr("multiple","true").on("change",function(e){e.preventDefault();D(this.files)})}else{e(".afile",i).on("change",function(t){t.preventDefault();p.empty();c.show();d.css("width","5%");var a={};if(s.csrfToken)a[s.csrfTokenName]=s.csrfToken;e.ajax({type:"POST",url:s.uploadUrl,data:a,files:e(this),iframe:true,processData:false,dataType:"json"}).done(function(e){var t=v(e["id"],e["preview"],e["name"],e["description"],e["rank"]);o.append(t);if(s.hasName||s.hasDesc)p.append(f(e["id"],e["preview"],e["name"],e["description"]));d.css("width","100%");c.hide();if(s.hasName||s.hasDesc)l.modal("show")})})}e(".save-changes",l).click(function(t){t.preventDefault();e.post(s.updateUrl,e("input, textarea",p).serialize()+"&ajax=true"+r,function(t){var a=t.length;for(var r=0;r<a;r++){var o=t[r];var c=e("#"+s.wId+"-"+o.id);e("img",c).attr("src",o["src"]);if(s.hasName)e(".caption h5",c).text(o["name"]);if(s.hasDesc)e(".caption p",c).text(o["description"])}l.modal("hide");e(".photo.selected",n).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected");e(".select_all",i).prop("checked",false);g()},"json")});e(".edit_selected",i).click(function(t){t.preventDefault();var a=0;var r=p.empty();e(".photo.selected",n).each(function(){a++;var t=e(this),i=t.attr("id").substr((s.wId+"-").length),n=e("img",t[0]).attr("src"),o=e(".caption h5",t[0]).text(),l=e(".caption p",t[0]).text();r.append(f(i,n,o,l))});if(a>0)l.modal("show");return false});e(".remove_selected",i).click(function(t){t.preventDefault();e(".photo.selected",n).each(function(){var t=e(this).attr("id").substr((s.wId+"-").length);e.ajax({type:"POST",url:s.deleteUrl,data:"id="+t+r,success:function(a){if(a=="OK")e("#"+s.wId+"-"+t).remove();else alert(a)}})})});e(".select_all",i).change(function(){if(e(this).prop("checked")){e(".photo",n).each(function(){e(".photo-select",this).prop("checked",true)}).addClass("selected")}else{e(".photo.selected",n).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected")}g()});for(var b in s.photos){var x=s.photos[b];var T=v(x["id"],x["preview"],x["name"],x["description"],x["rank"]).data("data",x);o.append(T)}}e.fn.galleryManager=function(e){if(this.length){this.each(function(){t(this,e)})}}})(jQuery);